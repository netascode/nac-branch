name: Check md files vs API

on:
  schedule:
    - cron: "20 6 * * *"  # every day at 06:20 UTC
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to check files in"
        required: true
        default: "gh-action-for-ids"

env:
  BASE_URL: ${{ secrets.BASE_URL }}
  NETWORK_ID: ${{ secrets.NETWORK_ID }}
  API_KEY: ${{ secrets.MERAKI_API_KEY }}

jobs:
  compare_md_with_api:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Compare .md files with API
        shell: /usr/bin/bash
        run: |
          REF_FILE_CF="docs/ContentFilteringCategories.md"
          REF_FILE_APP="docs/applicationCategories.md"
          API_TMP_CF="tmp_api_CF.md"
          API_TMP_APP="tmp_api_APP.md"
          MISMATCH=0

          echo "=== Fetching contentFiltering categories ==="
          curl -s -H "X-Cisco-Meraki-API-Key: $API_KEY" \
            "$BASE_URL/networks/$NETWORK_ID/appliance/contentFiltering/categories" \
            | jq -r '.[] | "id: \(.id)\nname: \(.name)\n"' > "$API_TMP_CF"

          echo "=== Comparing contentFiltering categories ==="
          while IFS= read -r ref_line; do
            api_line=$(grep -F "$ref_line" "$API_TMP_CF" || true)
            if [ -z "$api_line" ]; then
              echo "❌ Mismatch or missing line in API: '$ref_line'"
              MISMATCH=1
            fi
          done < "$REF_FILE_CF"

          while IFS= read -r api_line; do
            ref_line=$(grep -F "$api_line" "$REF_FILE_CF" || true)
            if [ -z "$ref_line" ]; then
              echo "⚠ Extra line in API not in reference: '$api_line'"
              MISMATCH=1
            fi
          done < "$API_TMP_CF"

          echo "=== Fetching application categories ==="
          curl -s -H "X-Cisco-Meraki-API-Key: $API_KEY" \
            "$BASE_URL/networks/$NETWORK_ID/appliance/firewall/l7FirewallRules/applicationCategories" \
            | jq -r '
              .applicationCategories[] |
              "category_id: \(.id)\ncategory_name: \(.name)" + (
                if .applications then
                  "\n" + (.applications[] | "  app_id: \(.id)\n  app_name: \(.name)")
                else "" end
              )
            ' > "$API_TMP_APP"

          echo "=== Comparing application categories ==="
          while IFS= read -r ref_line; do
            api_line=$(grep -F "$ref_line" "$API_TMP_APP" || true)
            if [ -z "$api_line" ]; then
              echo "❌ Mismatch or missing line in API: '$ref_line'"
              MISMATCH=1
            fi
          done < "$REF_FILE_APP"

          while IFS= read -r api_line; do
            ref_line=$(grep -F "$api_line" "$REF_FILE_APP" || true)
            if [ -z "$ref_line" ]; then
              echo "⚠ Extra line in API not in reference: '$api_line'"
              MISMATCH=1
            fi
          done < "$API_TMP_APP"

          if [ $MISMATCH -eq 1 ]; then
            echo "❌ Category/application mismatches detected. Failing workflow."
            exit 1
          else
            echo "✅ All categories and applications match reference."
