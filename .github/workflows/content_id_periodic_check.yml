name: Check md files vs API

on:
  schedule:
    - cron: "20 6 * * *"
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to check files in"
        required: true
        default: "gh-action-for-ids"

env:
  BASE_URL: ${{ secrets.BASE_URL }}
  NETWORK_ID: ${{ secrets.NETWORK_ID }}
  API_KEY: ${{ secrets.MERAKI_API_KEY }}

jobs:
  check_categories:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Check contentFiltering categories
        run: |
          REF_FILE_CF="docs/ContentFilteringCategories.md"
          API_TMP_CF="tmp_api_CF.md"
          MISMATCH=0

          echo "=== Fetching contentFiltering categories ==="
          curl -s -H "X-Cisco-Meraki-API-Key: $API_KEY" \
            "$BASE_URL/networks/$NETWORK_ID/appliance/contentFiltering/categories" \
            | jq -r '.[] | "id: \(.id)\nname: \(.name)\n"' > "$API_TMP_CF"

          echo "=== Comparing contentFiltering categories ==="
          while IFS= read -r ref_line; do
            api_line=$(grep -F "$ref_line" "$API_TMP_CF" || true)
            if [ -z "$api_line" ]; then
              echo "❌ Mismatch or missing line in API: '$ref_line'"
              MISMATCH=1
            fi
          done < "$REF_FILE_CF"

          # Check for extra items in API not in reference
          while IFS= read -r api_line; do
            ref_line=$(grep -F "$api_line" "$REF_FILE_CF" || true)
            if [ -z "$ref_line" ]; then
              echo "⚠ Extra line in API not in reference: '$api_line'"
              MISMATCH=1
            fi
          done < "$API_TMP_CF"

          if [ $MISMATCH -eq 1 ]; then
            echo "contentFiltering categories mismatch detected. Failing workflow."
            exit 1
          else
            echo "✅ All contentFiltering categories match reference."

      - name: Check application categories
        run: |
          REF_FILE_APP="docs/applicationCategories.md"
          API_TMP_APP="tmp_api_APP.md"
          MISMATCH=0

          echo "=== Fetching application categories ==="
          curl -s -H "X-Cisco-Meraki-API-Key: $API_KEY" \
            "$BASE_URL/networks/$NETWORK_ID/appliance/firewall/l7FirewallRules/applicationCategories" \
            | jq -r '
                .applicationCategories[] as $cat |
                "id: \($cat.id)\nname: \($cat.name)\n" +
                ($cat.applications[]? | "  id: \(.id)\n  name: \(.name)\n")
              ' > "$API_TMP_APP"

          echo "=== Comparing application categories ==="
          while IFS= read -r ref_line; do
            api_line=$(grep -F "$ref_line" "$API_TMP_APP" || true)
            if [ -z "$api_line" ]; then
              echo "❌ Mismatch or missing line in API: '$ref_line'"
              MISMATCH=1
            fi
          done < "$REF_FILE_APP"

          # Check for extra items in API not in reference
          while IFS= read -r api_line; do
            ref_line=$(grep -F "$api_line" "$REF_FILE_APP" || true)
            if [ -z "$ref_line" ]; then
              echo "⚠ Extra line in API not in reference: '$api_line'"
              MISMATCH=1
            fi
          done < "$API_TMP_APP"

          if [ $MISMATCH -eq 1 ]; then
            echo "application categories mismatch detected. Failing workflow."
            exit 1
          else
            echo "✅ All application categories match reference."
