name: Check md files vs API

env:
  BASE_URL: ${{ secrets.BASE_URL }}
  NETWORK_ID: ${{ secrets.NETWORK_ID }}
  API_KEY: ${{ secrets.MERAKI_API_KEY }}

on:
  schedule:
    - cron: "20 6 * * *" # every day at 06:20 UTC
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to check files in"
        required: true
        default: "gh-action-for-ids"

jobs:
  check_categories:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Compare Categories JSON
        run: |
          # Save API JSON to file (replace with actual curl/fetch if needed)
          # curl -s -H "X-Cisco-Meraki-API-Key: $API_KEY" \
          #   "$BASE_URL/networks/$NETWORK_ID/appliance/contentFiltering/categories" \
          #   -o api_Categories.json

          # Use the reference file already in the repo
          REF_FILE="reference_Categories.json"
          API_FILE="api_Categories.json"

          MISMATCH=0

          # Compare contentFiltering categories
          for id in $(jq -r '.categories[].id' "$REF_FILE"); do
            REF_NAME=$(jq -r ".categories[] | select(.id==\"$id\") | .name" "$REF_FILE")
            API_NAME=$(jq -r ".categories[] | select(.id==\"$id\") | .name // empty" "$API_FILE")
            if [ "$REF_NAME" != "$API_NAME" ]; then
              echo "Mismatch for category ID $id: ref='$REF_NAME', api='$API_NAME'"
              MISMATCH=1
            fi
          done

          # Compare applicationCategories
          for cat_id in $(jq -r '.applicationCategories[].id' "$REF_FILE"); do
            REF_CAT_NAME=$(jq -r ".applicationCategories[] | select(.id==\"$cat_id\") | .name" "$REF_FILE")
            API_CAT_NAME=$(jq -r ".applicationCategories[] | select(.id==\"$cat_id\") | .name // empty" "$API_FILE")
            if [ "$REF_CAT_NAME" != "$API_CAT_NAME" ]; then
              echo "Mismatch for application category ID $cat_id: ref='$REF_CAT_NAME', api='$API_CAT_NAME'"
              MISMATCH=1
            fi

            # Compare applications inside this category
            for app_id in $(jq -r ".applicationCategories[] | select(.id==\"$cat_id\") | .applications[].id" "$REF_FILE"); do
              REF_APP_NAME=$(jq -r ".applicationCategories[] | select(.id==\"$cat_id\") | .applications[] | select(.id==\"$app_id\") | .name" "$REF_FILE")
              API_APP_NAME=$(jq -r ".applicationCategories[] | select(.id==\"$cat_id\") | .applications[] | select(.id==\"$app_id\") | .name // empty" "$API_FILE")
              if [ "$REF_APP_NAME" != "$API_APP_NAME" ]; then
                echo "Mismatch for application ID $app_id in category $cat_id: ref='$REF_APP_NAME', api='$API_APP_NAME'"
                MISMATCH=1
              fi
            done
          done

          if [ $MISMATCH -eq 1 ]; then
            echo "Category/application mismatches detected. Failing workflow."
            exit 1
          else
            echo "All categories and applications match reference."
