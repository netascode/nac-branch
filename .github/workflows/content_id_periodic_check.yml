name: Check md files vs API

env:
  BASE_URL: ${{ secrets.BASE_URL }}
  NETWORK_ID: ${{ secrets.NETWORK_ID }}
  API_KEY: ${{ secrets.MERAKI_API_KEY }}

on:
  schedule:
    - cron: "20 6 * * *" # every day at 06:20 UTC
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to check files in"
        required: true
        default: "gh-action-for-ids"

jobs:
  check:
    name: Verify Content Filtering Categories and Application Categories IDs
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency: md_check

    steps:
      - name: Checkout branch
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.inputs.branch || github.ref_name }}

      - name: Fetch API outputs
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          NETWORK_ID: ${{ secrets.NETWORK_ID }}
          API_KEY: ${{ secrets.MERAKI_API_KEY }}
        run: |
          curl -s -H "X-Cisco-Meraki-API-Key: $API_KEY" \
            "$BASE_URL/networks/$NETWORK_ID/appliance/firewall/l7FirewallRules/applicationCategories" \
            > api_applicationCategories.txt

          curl -s -H "X-Cisco-Meraki-API-Key: $API_KEY" \
            "$BASE_URL/networks/$NETWORK_ID/appliance/contentFiltering/categories" \
            > api_ContentFilteringCategories.txt

      - name: Compare applicationCategories
        id: compare1
        run: |
          if [ -f "docs/applicationCategiories.md" ]; then
            if ! diff -u docs/applicationCategiories.md api_applicationCategories.txt > diff_app.txt; then
              echo "APP_MISMATCH=true" >> $GITHUB_ENV
            else
              echo "APP_MISMATCH=false" >> $GITHUB_ENV
            fi
          else
            echo "applicationCategiories.md not found in branch"
            echo "APP_MISMATCH=skipped" >> $GITHUB_ENV
          fi

      - name: Compare ContentFilteringCategories
        id: compare2
        run: |
          if [ -f "docs/ContentFilteringCategories.md" ]; then
            if ! diff -u docs/ContentFilteringCategories.md api_ContentFilteringCategories.txt > diff_filter.txt; then
              echo "FILTER_MISMATCH=true" >> $GITHUB_ENV
            else
              echo "FILTER_MISMATCH=false" >> $GITHUB_ENV
            fi
          else
            echo "ContentFilteringCategories.md not found in branch"
            echo "FILTER_MISMATCH=skipped" >> $GITHUB_ENV
          fi

      - name: Webex Notification
        if: always()
        uses: qsnyder/action-wxt@master
        env:
          TOKEN: ${{ secrets.WEBEX_TOKEN }}
          ROOMID: ${{ secrets.WEBEX_ROOM_ID }}
          MESSAGE: |
            [**[${{ job.status }}] ${{ github.repository }} #${{ github.run_number }}**](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            * Job: ${{ github.job }}
            * Branch: ${{ github.ref }}
            * Event: ${{ github.event_name }}
            * applicationCategiories mismatch: ${{ env.APP_MISMATCH }}
            * ContentFilteringCategories mismatch: ${{ env.FILTER_MISMATCH }}
