# The below code does the following:
#
# This YAML file defines templates which provide the following set of
# Unified Branch services applicable to the security appliance:
#
# - Appliance settings - defined in the app_settings template
# - AutoVPN configuration (spoke) - defined in the app_spoke template
# - Port configuration - defined in the app_ports template
# - VLAN configuration - defined in the app_vlans template
# - Firewall configuration - defined in the app_fw template
# - WAN uplink traffic shaping configuration - defined in the app_ts template
# - Content filtering - defined in the app_content template
# - Intrusion prevention - defined in the app_intrusion template
# - Malware prevention - defined in the app_mal template
# - WAN uplink traffic steering configuration - defined in the trafficsteering template
# - Static route configuration - defined in the app_static_routes template
#
# Note that these templates are not related to templates
# configured within the Cisco (formerly Meraki) dashboard.
#
meraki:
  template:
    networks:
      #
      # The below code does the following:
      #
      # Security appliance settings configuration template for branch networks.
      #
      # Sets the security appliance for routed mode operation, tracks clients by
      # MAC address, and enables dynamic DNS for accessing the security appliance.
      #
      - name: app_settings
        appliance:
                settings:
                  client_tracking_method: "MAC address"
                  deployment_mode: routed
                  dynamic_dns:
                    prefix: "my-network"
                    enabled: true

      # The below code does the following:
      #
      # Security appliance AutoVPN configuration template for the hub network.
      #
      # Configures the network to which the template is applied as a hub and advertises the 
      # VLAN 10 (data) and VLAN 20 (voice) subnets across the VPN 
      # to the cloud. IP address and subnets for VLANs are specified as variables which 
      # are defined in the pods_variables.nac.yaml file.
      #      
      - name: app_hub
        appliance:
                vpn_site_to_site_vpn:
                  mode: hub
                  subnets:
                    - local_subnet: ${vlan10_subnet}
                      use_vpn: true
                    - local_subnet: ${vlan20_subnet}
                      use_vpn: true
      # 
      # The below code does the following:
      #
      # Security appliance AutoVPN configuration template for branch networks.
      #
      # Configures the branch netowrk to which the template is applied as a spoke with a single 
      # hard-coded hub named "Unified Hub" which is also the default route for all spoke networks.  
      #
      # Advertises the VLAN 10 (data) and VLAN 20 (voice) subnets across the VPN 
      # to the cloud. IP address and subnets for VLANs are specified as variables which 
      # are defined in the pods_variables.nac.yaml file.
      #
      - name: app_spoke
        appliance:              
                vpn_site_to_site_vpn:
                  mode: spoke
                  hubs:
                    - hub_network_name: ${hub_network_name}
                      use_default_route: true
                  subnets:
                    - local_subnet: ${vlan10_subnet}
                      use_vpn: true
                    - local_subnet: ${vlan20_subnet}
                      use_vpn: true
      # 
      # The below code does the following:
      #
      # Security appliance LAN port configuration template.
      # Configures and enables LAN ports 5, 6, 13, & 14 as trunks to the branch switch, 
      # allowing VLANs 1, 10, 20 and 30. Only port 6 was connected to the switch
      # for validation. Native VLAN 1 on the trunk serves as an Infrastructure VLAN, 
      # allowing devices downstream of the security appliance to get IP addresses and 
      # communicate with the Cisco (formerly Meraki) cloud. VLANs 10, 20, & 30 correspond 
      # to Data, Voice, & Guest VLANs. 
      #
      - name: app_ports
        appliance:
          ports:
            - port_id: 5
              enabled: true
              type: trunk
              allowed_vlans: "1,10,20,30"
              vlan: 1              
            - port_id: 6
              enabled: true
              type: trunk
              allowed_vlans: "1,10,20,30"
              vlan: 1
            - port_id: 13
              enabled: true
              type: trunk
              allowed_vlans: "1,10,20,30"          
            - port_id: 14
              enabled: true
              type: trunk
              allowed_vlans: "1,10,20,30"
      #
      # The below code does the following:
      #
      # Security appliance VLAN configuration template.
      #
      # This template hardcodes the configuration for 4 VLANs - VLAN 10 (Data),
      # VLAN 20 (Voice) and VLAN 30 (Guest).  For each 
      # VLAN, the IPv4 subnet and address of the security appliance are defined
      # as variables.   IPv6 is disabled for each VLAN. 
      
      # A separate DHCP server instance is also configured within each VLAN to 
      # assign IP addresses to client devices for the VLAN, with the following 
      # example configuration:
      #
      # - Mandatory IP address assignment via the security appliance
      # - PXE boot disabled
      # - Custom DNS server specified via the domain name "upstream_dns" 
      # - DHCP lease time of 1 day
      # - Reserved IP addresses (start and end) specified defined as variables
      # - DHCP options 66 (tftp server) and 67 (bootfile) configured as examples
      #   (even though PXE boot is disabled via the dhcp_boot_options setting)
      # - No fixed IP address assignments
      #      
      - name: app_vlans
        appliance:
          vlans_settings: true
          vlans:
            - vlan_id: 10
              name: "Data"
              subnet:  ${vlan10_subnet}
              appliance_ip: ${vlan10_appliance_ip}
              ipv6:
                enabled: false
              dns_nameservers: upstream_dns  
              dhcp_handling: "Run a DHCP server"
              dhcp_lease_time: "1 day"
              dhcp_boot_options: false
              dhcp_options:
                - code: "66"
                  type: "text"
                  value: "tftp.example.com"
                - code: "67"
                  type: "text"
                  value: "bootfile"
              reserved_ip_ranges:
                - start: ${vlan10_dhcp_start}
                  end: ${vlan10_dhcp_end}
                  comment: "Reserved"
              mandatory_dhcp: true
            - vlan_id: 20
              name: "Voice"
              subnet: ${vlan20_subnet}
              appliance_ip: ${vlan20_appliance_ip}
              ipv6:
                enabled: false
              dns_nameservers: upstream_dns  
              dhcp_handling: "Run a DHCP server"
              dhcp_lease_time: "1 day"
              dhcp_boot_options: false
              dhcp_options:
                - code: "66"
                  type: "text"
                  value: "tftp.example.com"
                - code: "67"
                  type: "text"
                  value: "bootfile"
              reserved_ip_ranges:
                - start: ${vlan20_dhcp_start}
                  end: ${vlan20_dhcp_end}
                  comment: "Reserved"
              mandatory_dhcp: true
            - vlan_id: 30
              name: "Guest"
              subnet: ${vlan30_subnet}
              appliance_ip: ${vlan30_appliance_ip}
              ipv6:
                enabled: false
              dns_nameservers: upstream_dns
              dhcp_handling: "Run a DHCP server"
              dhcp_lease_time: "1 day"
              dhcp_boot_options: false
              dhcp_options:
                - code: "66"
                  type: "text"
                  value: "tftp.example.com"
                - code: "67"
                  type: "text"
                  value: "bootfile"
              reserved_ip_ranges:
                - start: ${vlan30_dhcp_start}
                  end:  ${vlan30_dhcp_end}
                  comment: "Reserved"
              mandatory_dhcp: true
      #
      # The below code does the following:
      #
      # Security appliance L3 & L7 firewall configuration template.
      #
      # This template hardcodes the following firewall rules on the 
      # security appliance.  The rules are configured as examples only. 
      # Network administrators should configure firewall rule based on 
      # the security policy of their individual organizations.
      #
      # - Outbound Layer 3 firewall rules:
      #   - Deny UDP traffic from any source IP address with source port 1433
      #     to any destination IP address with destination port 1433.
      #   - Deny TCP traffic from any source IP address with source port 22
      #     to any destination IP address with destination port 22.
      #     (Note, this is technially not SSH traffic since SSH uses an ephemeral
      #     source TCP port.)
      #
      # - Services available / blocked from the outside interface of the security
      #   appliance
      #   - ICMP services blocked
      #   - Web services restricted to being reachable from IP addresses "2.2.2.2 and
      #     3.3.3.3" only
      #   - SNMP services allowed
      #
      # - Outbound Layer 7 firewall rules:
      #   - Deny application category "meraki:layer7/category/27"
      #     (Note that application categories must be specified by ID currently.
      #     Work to translate the IDs into user-friendly names is ongoing.)
      #   - Deny application name "meraki:layer7/application/106"
      #     (Note that applications must be specified by ID currently. Work to
      #     translate the IDs into user-friengly names is ongoing.)
      #   - Deny traffic from host specified by name "abc.com"
      #   - Deny traffic from any host to port "161"
      #     (Question:  Is this UDP or TCP, Source or Destination????)
      #   - Deny traffic to remote IP address "192.168.0.1"
      #   - Deny traffic to remote IP address "192.168.0.2" port "80"
      #
      - name: app_fw
        appliance:
          firewall:
                  l3_firewall_rules:
                      rules:
                      - comment: "Block Bad Traffic"
                        policy: deny
                        protocol: udp
                        source_port: 1433
                        source_cidr: Any
                        destination_port: 1433
                        destination_cidr: Any
                      - comment: "Block SSH"
                        policy: deny
                        protocol: tcp
                        source_port: 22
                        source_cidr: Any
                        destination_port: 22
                        destination_cidr: Any
                  firewalled_services:
                      - service_name: "ICMP"
                        access: "blocked"
                      - service_name: "web"
                        access: "restricted"
                        allowed_ips:
                          - "2.2.2.2"
                          - "3.3.3.3"
                      - service_name: "SNMP"
                        access: "unrestricted"
                  l7_firewall_rules:
                      - policy: deny
                        type: applicationCategory
                        value: "meraki:layer7/category/27"
                      - policy: deny
                        type: application
                        value: "meraki:layer7/application/106"
                      - policy: deny
                        type: host
                        value: "abc.com"
                      - policy: deny
                        type: port
                        value: "161"
                      - policy: deny
                        type: ipRange
                        value: "192.168.0.1"
                      - policy: deny
                        type: ipRange
                        value: "192.168.0.2:80"
      #
      # The below code does the following:
      #
      # Security appliance traffic shaping configuration template.
      #
      # This template applies to VPN (tunneled) traffic across the WAN
      # interfaces of the security appliance.  It consists of the following 
      # 4 sections:
      #
      # - global_bandwidth_limits
      # - custom_performance_classes
      # - rules
      # - uplink_bandwidth_limits
      # - uplink_selection
      #
      # The global_bandwidth_limits section configures per-client 
      # rate-limiting both upstream and downstream.  The example within
      # configures a limit of 10,000 Kbps or 10 Mbps per client in the
      # in the upstream and downstream direction.
      #
      # The rules section does.....TBD.....
      #
      # The custom_performance_classes section defines an example custom 
      # (non-builtin) performance class named "Radius", and sets the max
      # latency and max jitter tolerances at 30 milliseconds, and the 
      # max loss percentage at 5% in order for traffic to be within the 
      # SLA of the performance class.  Note that performance classes defined
      # here can apply to either VPN or non-VPN (Internet) traffic across 
      # WAN uplinks.
      #
      # The uplink_bandwidth_limits section sets the uplink and downlink
      # bandwidth limits for all traffic from all clients on each WAN uplink.
      # This is essentially equivalent to sub-line rate limiting to the 
      # speed of carrier, even though the physical connection may be 1 Gbps 
      # Ethernet.  The example configuration sets the rate-limit to 700,000 Kbps 
      # (700 Mbps) upstream and downstream for both WAN uplinks.
      # 
      # the uplink_selection section does.....TBD......
      #
      - name: app_ts
        appliance:
            traffic_shaping:
                    global_bandwidth_limits:
                        limit_up: 10000
                        limit_down: 10000
                    custom_performance_classes:
                      - name: Radius
                        max_latency: 30
                        max_jitter: 30
                        max_loss_percentage: 5
                    rules:
                        rules:
                          - name: Rule 01
                            definitions:
                              - type: applicationCategory
                                value: "meraki:layer7/category/24"
                              - type: application
                                value: meraki:layer7/application/332
                              - type: application
                                value: meraki:layer7/application/2249
                              - type: application
                                value: meraki:layer7/application/351
                              - type: application
                                value: meraki:layer7/application/2248
                              - type: application
                                value: meraki:layer7/application/2542
                            per_client_bandwidth_limits:
                                settings: custom
                                bandwidth_limits:
                                  limit_up: 1000
                                  limit_down: 1000
                            dscp_tag_value: 18
                            priority: high
                          - name: Rule 02
                            definitions:
                              - type: applicationCategory
                                value: "meraki:layer7/category/24"
                              - type: application
                                value: meraki:layer7/application/332
                            per_client_bandwidth_limits:
                                settings: ignore
                            dscp_tag_value: 18
                            priority: high
                        default_rules: false   
                    uplink_bandwidth_limits:
                        wan1:
                            limit_up: 700000
                            limit_down: 700000
                        wan2:
                            limit_up: 700000
                            limit_down: 700000
                        # cellular:
                        #     limit_up: 0
                        #     limit_down: 0
                    uplink_selection:
                        default_uplink: wan1
                        active_active_auto_vpn: true
                        load_balancing: true
                        failover_and_failback_immediate: true
                        wan_traffic_uplink_preferences:
                        - name: policy 1
                          preferred_uplink: "wan1"
                          traffic_filters:
                            - type: custom
                              value:
                                protocol: tcp
                                source:
                                    port: "1-1024"
                                    cidr: any
                                destination:
                                    cidr: any
                                    port: any
                        - name: policy 2
                          preferred_uplink: "wan1"
                          traffic_filters:
                            - type: custom
                              value:
                                protocol: tcp
                                source:
                                    port: any
                                    cidr: ${vlan10_subnet}
                                destination:
                                    cidr: any
                                    port: "443"
                        vpn_traffic_uplink_preferences:
                        - name: policy 1
                          preferred_uplink: wan1
                          traffic_filters:
                            - type: application
                              value:
                                id: meraki:layer7/application/375
                            # - type: "custom"
                            #   value:
                            #     protocol: any
                            #     source:
                            #         port: any
                            #         cidr: any
                            #     destination:
                            #         port: any
                            #         cidr: any
                          fail_over_criterion: poorPerformance
                          performance_class:
                            type: builtin
                            builtin_performance_class_name: VoIP
                        - name: policy 2
                          preferred_uplink: wan1
                          traffic_filters:
                            - type: application
                              value:
                                id: meraki:layer7/application/4
                            # - type: "custom"
                            #   value:
                            #     protocol: any
                            #     source:
                            #         port: any
                            #         cidr: any
                            #     destination:
                            #         port: any
                            #         cidr: any
                          fail_over_criterion: poorPerformance
                          performance_class:
                            type: builtin
                            builtin_performance_class_name: VoIP
      #
      # The below code does the following:
      #
      # Security appliance content filtering configuration template.
      #
      # The following template enables content filtering on the security
      # appliance. List entries under allowed_url_patterns, blocked_url_patterns,
      # and blocked_url_categories are examples only.  Network administrators 
      # should configure content filtering rules based on the security policy and 
      # requirements of their individual organizations.

      # - List entries under allowed_url_patterns are specific URLs excluded from 
      #   content filtering and therefore allowed. 
      # - List entries under blocked_url_patterns are automatically blocked. 
      # -  List entries under blocked_url_categories consist of categories of URLs 
      #    automatically blocked. (Note that URL category must be specified  by ID 
      #    currently. Work to translate the IDs into user-friendly names is ongoing.)
      #
      - name: app_content
        appliance:
            content_filtering:
                allowed_url_patterns:
                      - "www.cisco.com"
                      - "*.meraki.com"
                blocked_url_patterns:
                      - www.porn.com
                      - www.socialmedia.net
                      - www.example.badsitehere.com
                blocked_url_categories:
                      - "meraki:contentFiltering/category/C6"
                      - "meraki:contentFiltering/category/C69"
                      - "meraki:contentFiltering/category/C55"
                      - "meraki:contentFiltering/category/C47"
                      - "meraki:contentFiltering/category/C84"
                      - "meraki:contentFiltering/category/C22"
                      - "meraki:contentFiltering/category/T01"
                      - "meraki:contentFiltering/category/T03"
                      - "meraki:contentFiltering/category/T14"
                      - "meraki:contentFiltering/category/T05"
                      - "meraki:contentFiltering/category/T02"
                      - "meraki:contentFiltering/category/C36"
                url_category_list_size: fullList
      #
      # The below code does the following:
      #
      # Security appliance intrusion prevention configuration template.
      #
      # The following template enables intrusion prevention on the security
      # appliance and hardcodes a balanced ruleset, which is a compromise between
      # performance and security. Note that no exclusion rules have been configured.
      #
      - name: app_intrusion
        appliance:
          security_intrusion:
            mode: prevention
            ids_rulesets: balanced
      #
      # The below code does the following:
      #
      # Security appliance advanced malware prevention configuration template.
      #
      # The following template enables advanced malware protection on the
      # security appliance.  The hardcoded allowed_urls list ("www.cisco.com
      # and *.meraki.com") are excluded from malware scanning.  The hardcoded
      # allowed_files list contains files previously seen across the organization
      # which were blocked.  Currently these are specified as SHA-256 hash strings.
      # Work to translate the hash strings into user-friendly names is ongoing.
      #
      - name: app_mal
        appliance:
          security_malware:
                    mode: enabled
                    allowed_urls:
                      - url: "www.cisco.com"
                        comment: "Cisco"
                      - url: "*.meraki.com"
                        comment: "Meraki"
                    allowed_files:
                      - sha256: "1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
                        comment: "Test File 1"
                      - sha256: "abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
                        comment: "Test File 2"
      #
      # The below code does the following:
      #
      # Security appliance traffic steering configuration template.
      #
      # This template provides an example of how to configure SD-WAN policies for 
      # Internet traffic (SD-Internet).  The SD-Interent function is to steer customer
      # traffic to SaaS or public cloud-based applications (outside of any transport
      # tunnel) over the best-performing WAN connection at the time the traffic is forwarded.
      # The policies are configured as examples only. Network administrators should configure 
      # Internet traffic-steering policies based on the requirements the of their individual 
      # organizations.
      # 
      # The first policy is a custom policy matching on any TCP traffic from any source
      # IP address with source port in the range of 1 - 1024, to any destination and any
      # destination port.  The policy uses the built-in performance class named "VoIP" to 
      # preferred the WAN 1 uplink and failover if the performance is outside the SLA of the 
      # performance class.
      #
      # The second policy is a policy in which the major application specified by the ID 
      # "meraki:layer7/application/1" - which happens to be the Office 365 Suite - is
      # configured to use the built-in performance class named "VoIP" to prefer the WAN 1 
      # uplink and failover if the performance is outside the SLA of the performance class.
      # (Note that the major application must be specified  by ID currently. Work to translate
      # the IDs into user-friendly names is ongoing.)
      #  
      - name: tfsteering 
        appliance:
          sdwan_internet_policies:
            - name: policy 1
              traffic_filters:
                - type: custom
                  value:
                    protocol: "tcp"
                    source:
                      port: "1-1024"
                      cidr: "any"
                    destination:
                      port: "any"
                      cidr: "any"
              preferred_uplink: "wan1"
              fail_over_criterion: "poorPerformance"
              performance_class:
                type: builtin
                builtin_performance_class_name: VoIP
                custom_performance_class_id: "123456"
            - name: policy 2
              traffic_filters:
                - type: majorApplication
                  value:
                    protocol: "udp"
                    source:
                      port: "1-1024"
                      cidr: "any"
                    destination:
                      applications:
                        - id: "meraki:layer7/application/1"
                          name: "Office 365 Suite"
                          type: "major"
              preferred_uplink: "wan1"
              fail_over_criterion: "poorPerformance"
              performance_class:
                type: builtin
                builtin_performance_class_name: VoIP
                custom_performance_class_id: "123456"
      #
      # The below code does the following:
      #
      # Security appliance static routing configuration template.
      #
      # Static routes are used to reach subnets that are behind a layer 3 switch 
      # or otherwise not directly connected to or configured on the WAN appliance.
      # For Release 1 - Limited Availability it is assumed the switch attached to
      # the security appliance is a L2 switch.  Hence there should be no static
      # routes to be defined.  This section is therefore purely for example.
      # 
      # This template demonstrates how to configure two static routes in which 
      # the subnet/mask and gateway for each is defined as a variable.
      #
      - name: app_static_routes
        appliance:
          static_routes:
            - name: Static Route 01
              subnet: ${static_route1_subnet}
              gateway_ip: ${static_route1_gw}
            - name: Static Route 02
              subnet: ${static_route2_subnet}
              gateway_ip: ${static_route2_gw}
      - name: appl_comonitoring
        appliance:
          connectivity_monitoring_destinations:
                  - ip: "1.1.1.1"
                    description: Cloudflare DNS
                    default: true
